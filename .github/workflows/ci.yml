name: CI

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

# Cancel in-progress runs for the same workflow and branch
concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    lint-and-test:
        runs-on: ubuntu-latest
        timeout-minutes: 15
        permissions:
            contents: read
            pull-requests: read
        env:
            PMD_VERSION: '7.19.0'
        steps:
            # Pinned to commit SHA for security (immutable version)
            # actions/checkout version: v6
            - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8

            - name: Setup Java
              # Pinned to commit SHA for security (immutable version)
              # actions/setup-java version: v5
              uses: actions/setup-java@f2beeb24e141e01a676f977032f5a29d81c9e27e
              with:
                  distribution: 'temurin'
                  java-version: '21'

            - name: Setup Node.js
              # Pinned to commit SHA for security (immutable version)
              # actions/setup-node version: v6
              uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f
              with:
                  node-version: '24'

            - name: Setup pnpm
              # Pinned to commit SHA for security (immutable version)
              # pnpm/action-setup version: v4
              uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061
              with:
                  version: '10.26.2'

            - name: Cache pnpm store
              # Pinned to commit SHA for security (immutable version)
              # actions/cache version: v5
              uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb
              with:
                  path: ~/.local/share/pnpm/store
                  key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
                  restore-keys: |
                      ${{ runner.os }}-pnpm-store-

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Check XML formatting
              run: pnpm format:check

            - name: Check XML element order
              run: pnpm check-xml-order

            - name: Validate rulesets
              run: pnpm validate

            - name: Lint JavaScript
              run: pnpm lint

            - name: Cache PMD
              id: cache-pmd
              # Pinned to commit SHA for security (immutable version)
              # actions/cache version: v5
              uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb
              with:
                  path: ~/pmd
                  key: pmd-${{ env.PMD_VERSION }}
                  restore-keys: |
                      pmd-

            - name: Install PMD CLI
              if: steps.cache-pmd.outputs.cache-hit != 'true'
              run: |
                  set -euo pipefail
                  PMD_VERSION="${{ env.PMD_VERSION }}"
                  PMD_DIR="$HOME/pmd/pmd-bin-${PMD_VERSION}"
                  DOWNLOAD_URL="https://github.com/pmd/pmd/releases/download/pmd_releases%2F${PMD_VERSION}/pmd-dist-${PMD_VERSION}-bin.zip"

                  echo "Downloading PMD ${PMD_VERSION} from ${DOWNLOAD_URL}"
                  mkdir -p ~/pmd

                  if ! curl -fsSL -o pmd-bin.zip "${DOWNLOAD_URL}"; then
                    echo "Error: Failed to download PMD ${PMD_VERSION}"
                    exit 1
                  fi

                  if [ ! -f pmd-bin.zip ]; then
                    echo "Error: Download file not found"
                    exit 1
                  fi

                  echo "Extracting PMD..."
                  unzip -q pmd-bin.zip

                  if [ ! -d "pmd-bin-${PMD_VERSION}" ]; then
                    echo "Error: PMD extraction failed - directory not found"
                    exit 1
                  fi

                  mv "pmd-bin-${PMD_VERSION}" ~/pmd
                  rm -f pmd-bin.zip
                  echo "PMD ${PMD_VERSION} installed successfully"

            - name: Setup PMD CLI
              run: |
                  set -euo pipefail
                  PMD_VERSION="${{ env.PMD_VERSION }}"
                  PMD_DIR="$HOME/pmd/pmd-bin-${PMD_VERSION}"
                  PMD_BIN="${PMD_DIR}/bin/pmd"

                  if [ ! -d "${PMD_DIR}" ]; then
                    echo "Error: PMD directory not found at ${PMD_DIR}"
                    echo "Contents of ~/pmd:"
                    ls -la "$HOME/pmd/" || echo "PMD cache directory does not exist"
                    exit 1
                  fi

                  if [ ! -f "${PMD_BIN}" ]; then
                    echo "Error: PMD binary not found at ${PMD_BIN}"
                    echo "Contents of ${PMD_DIR}/bin:"
                    ls -la "${PMD_DIR}/bin/" || echo "PMD bin directory does not exist"
                    exit 1
                  fi

                  echo "${PMD_DIR}/bin" >> $GITHUB_PATH
                  chmod +x "${PMD_BIN}"

                  echo "Verifying PMD installation..."
                  "${PMD_BIN}" --version

                  echo "Verifying PMD check command..."
                  if ! "${PMD_BIN}" check --help > /dev/null 2>&1; then
                    echo "Error: PMD check command failed"
                    exit 1
                  fi

                  echo "Verifying PMD with Apex language support..."
                  if ! "${PMD_BIN}" check --help | grep -q "apex"; then
                    echo "Warning: Apex language may not be available"
                  fi

                  echo "PMD CLI setup complete (version ${PMD_VERSION})"

            - name: Run tests
              run: pnpm test

            - name: Check rule coverage
              run: pnpm test:coverage

            - name: Upload coverage
              # Pinned to commit SHA for security (immutable version)
              # codecov/codecov-action version: v5
              uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de
              if: always()
              with:
                  files: ./coverage/lcov.info
                  token: ${{ secrets.CODECOV_TOKEN }}
                  fail_ci_if_error: false

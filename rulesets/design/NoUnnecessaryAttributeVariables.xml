<?xml version="1.0" ?>
<ruleset
	name="Apex Design Rules"
	xmlns="http://pmd.sourceforge.net/ruleset/2.0.0"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://pmd.sourceforge.net/ruleset/2.0.0 https://pmd.sourceforge.io/ruleset_2_0_0.xsd"
>
	<description>
		Custom rules for Apex design issues (structure, method signatures, class
		organization)
	</description>
	<rule
		name="NoUnnecessaryAttributeVariables"
		language="apex"
		message="Variables that extract a single attribute from an object and are only used once should be inlined. This rule only applies to primitive types, not collections or object instances"
		class="net.sourceforge.pmd.lang.rule.xpath.XPathRule"
	>
		<description>
			Variables that extract a single attribute from an object and are
			only used
			once should be inlined. This rule does not apply to collection types (List,
			Set, Map) or object/class instances, only primitive types. Inlining these
			variables reduces unnecessary indirection and improves code clarity.
			
			To customize this rule, edit the $primitiveTypes variable at the beginning
			of the XPath expression (default: 'String', 'Integer', 'Long', 'Double',
			'Decimal', 'Boolean', 'Date', 'DateTime', 'Time', 'Id', 'Blob'). This sets
			which types are considered primitive and subject to this rule.

			Version: 1.0.1
		</description>
		<priority>3</priority>
		<properties>
			<property name="xpath">
				<value>
					<![CDATA[
					let $primitiveTypes := (
							'String', 'Integer', 'Long', 'Double', 'Decimal',
							'Boolean', 'Date', 'DateTime', 'Time', 'Id', 'Blob'
						)
					return //VariableDeclaration[
						VariableExpression[1]/ReferenceExpression
						and @Type = $primitiveTypes
						and VariableExpression[2]
						and (
							let $varName := VariableExpression[2]/@Image,
								$method := ancestor::Method[1]
							return not(
								$method//AssignmentExpression[
									VariableExpression[@Image = $varName]
									and not(ancestor::VariableDeclaration[1] = .)
								]
							)
								and count(
									$method//VariableExpression[
										@Image = $varName
										and not(ancestor::VariableDeclaration[1] = .)
									]
								) = 1
						)
					]
					]]>
				</value>
			</property>
		</properties>
		<example>
			<![CDATA[
			// Violation: Variable used only once
			String name = account.Name;
			processName(name);
			
			// Violation: Primitive attribute extracted and used once
			Integer count = items.size();
			System.debug(count);
			
			// Valid: Inline the attribute access
			processName(account.Name);
			System.debug(items.size());
			]]>
		</example>
		<example>
			<![CDATA[
			// Valid: Variable used multiple times (not flagged)
			String name = account.Name;
			processName(name);
			System.debug(name);
			
			// Valid: Collection types are excluded
			List<String> names = account.Names;
			processNames(names);
			
			// Valid: Object instances are excluded
			Contact owner = account.Owner;
			processOwner(owner);
			
			// Valid: Variable reassigned (not flagged)
			String name = account.Name;
			name = 'Updated';
			processName(name);
			]]>
		</example>
	</rule>
</ruleset>

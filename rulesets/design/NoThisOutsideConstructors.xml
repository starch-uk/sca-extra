<?xml version="1.0" ?>
<ruleset
	name="Apex Design Rules"
	xmlns="http://pmd.sourceforge.net/ruleset/2.0.0"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://pmd.sourceforge.net/ruleset/2.0.0 https://pmd.sourceforge.io/ruleset_2_0_0.xsd"
>
	<description>
		Custom rules for Apex design issues (structure, method signatures, class
		organization)
	</description>
	<rule
		name="NoThisOutsideConstructors"
		language="apex"
		message="The 'this.' prefix should only be used inside constructors to disambiguate parameters from attributes. Methods may return 'this' but cannot use 'this.' to access class attributes"
		class="net.sourceforge.pmd.lang.rule.xpath.XPathRule"
	>
		<description>
			The 'this.' prefix should only be used inside constructors to
			disambiguate parameters from attributes. Methods may return 'this' (fluent
			interface pattern), but they cannot use 'this.' to access class attributes.
			Using 'this.' outside constructors is unnecessary and reduces code
			readability.

			Version: 1.0.1
		</description>
		<priority>2</priority>
		<properties>
			<property name="xpath">
				<value>
					<![CDATA[
					//ThisVariableExpression[
						not(ancestor::Method[@Constructor = true()])
						and not(ancestor::ReturnStatement)
					]
					]]>
				</value>
			</property>
		</properties>
		<example>
			<![CDATA[
			// Violation: Using this. outside constructor
			public void method() {
				this.value = 5;
			}
			
			// Violation: Using this. to access attribute
			public String getName() {
				return this.name;
			}
			
			// Violation: Using this. in method call
			public void process() {
				this.doSomething();
			}
			
			// Valid: Use this. only in constructor
			public MyClass(String name) {
				this.name = name;
			}
			
			// Valid: Returning this is allowed (fluent interface)
			public MyClass method() {
				return this;
			}
			
			// Valid: Access attribute without this.
			public String getName() {
				return name;
			}
			]]>
		</example>
		<example>
			<![CDATA[
			// Valid: Using this. in constructor to disambiguate
			public class Account {
				private String name;
				
				public Account(String name) {
					this.name = name;  // ✅ Disambiguates parameter from field
				}
			}
			
			// Violation: Using this. in regular method
			public class Account {
				private String name;
				
				public void setName(String name) {
					this.name = name;  // ❌ Not in constructor
				}
			}
			
			// Valid: Fluent interface pattern (returning this)
			public class Builder {
				private String value;
				
				public Builder setValue(String value) {
					this.value = value;  // ❌ Still a violation - not in constructor
					return this;  // ✅ Returning this is allowed
				}
			}
			]]>
		</example>
	</rule>
</ruleset>

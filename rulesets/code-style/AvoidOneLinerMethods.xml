<?xml version="1.0" ?>
<ruleset
	name="Apex Code Style Rules"
	xmlns="http://pmd.sourceforge.net/ruleset/2.0.0"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://pmd.sourceforge.net/ruleset/2.0.0 https://pmd.sourceforge.io/ruleset_2_0_0.xsd"
>
	<description>Custom rules for Apex code style and formatting</description>
	<rule
		name="AvoidOneLinerMethods"
		language="apex"
		message="Method contains only a single statement and should be inlined at its call site to reduce unnecessary indirection"
		class="net.sourceforge.pmd.lang.rule.xpath.XPathRule"
	>
		<description>
			Methods that contain only a single statement add unnecessary
			indirection
			and should be inlined at their call sites. This rule detects methods with
			exactly one statement in their body.
			
			Exceptions: Methods that are part of interfaces, abstract methods,
			override methods, overloaded methods, switch statements with more than
			one outcome, or methods that update a class attribute are excluded from
			this rule.
			
			To customize this rule, edit the $minParams variable at the beginning of
			the XPath expression (default: 1). This sets the minimum number of
			parameters a method must have to be flagged as a one-liner.

			Version: 1.0.1
		</description>
		<priority>4</priority>
		<properties>
			<property name="xpath">
				<value>
					<![CDATA[
					let $minParams := 1
					return //Method[
						not(ModifierNode[@Abstract = true()])
						and not(ModifierNode[@Override = true()])
						and not(ancestor::UserClass[@Interface = 'true'])
						and count(.//Parameter) >= $minParams
						and BlockStatement
						and count(BlockStatement/*) = 1
						and not(BlockStatement/EmptyStatement)
						and not(
							some $otherMethod in ancestor::UserClass//Method 
							satisfies $otherMethod/@Image = @Image 
							and $otherMethod/@BeginLine != @BeginLine
						)
						and not(
							BlockStatement/SwitchStatement
							and (
								count(BlockStatement/SwitchStatement/ValueWhenBlock) > 1
								or (count(BlockStatement/SwitchStatement/ValueWhenBlock) >= 1 and BlockStatement/SwitchStatement/ElseWhenBlock)
							)
						)
						and not(
							BlockStatement//AssignmentExpression/VariableExpression
							and not(
								some $var in ancestor::Method//VariableDeclaration
								satisfies $var/VariableDeclaratorId/@Image = BlockStatement//AssignmentExpression/VariableExpression/@Image
							)
						)
						and not(
							some $param in .//Parameter/VariableDeclaratorId/@Image
							satisfies count(BlockStatement//MethodCallExpression[.//VariableExpression/@Image = $param]) > 1
						)
					]
					]]>
				</value>
			</property>
		</properties>
		<example>
			<![CDATA[
			// Violation: One-liner method that should be inlined
			public Integer getValue() {
				return 5;
			}
			
			// Violation: One-liner method with single statement
			public String getName() {
				return 'John';
			}
			
			// Valid: Method with multiple statements
			public Integer getValue() {
				Integer value = calculateValue();
				return value * 2;
			}
			
			// Valid: Method with multiple statements
			public String getName() {
				String firstName = getFirstName();
				String lastName = getLastName();
				return firstName + ' ' + lastName;
			}
			]]>
		</example>
		<example>
			<![CDATA[
			// Valid: Abstract methods are excluded
			public abstract class Base {
				public abstract Integer getValue();  // ✅ Abstract methods excluded
			}
			
			// Valid: Override methods are excluded
			public class Child extends Base {
				@Override
				public Integer getValue() {  // ✅ Override methods excluded
					return 5;
				}
			}
			
			// Valid: Interface methods are excluded
			public interface MyInterface {
				Integer getValue();  // ✅ Interface methods excluded
			}
			
			// Valid: Overloaded methods are excluded
			public class Example {
				public Integer getValue() {  // ✅ Overloaded method
					return 5;
				}
				public Integer getValue(Integer multiplier) {  // ✅ Overloaded method
					return 5 * multiplier;
				}
			}
			]]>
		</example>
		<example>
			<![CDATA[
			// Valid: Methods that update class attributes are excluded
			public class Example {
				private Integer value;
				
				public void setValue(Integer newValue) {  // ✅ Updates class attribute
					this.value = newValue;
				}
			}
			
			// Valid: Switch statements with multiple outcomes are excluded
			public String getStatus(Integer code) {
				switch on code {
					when 1 { return 'Active'; }
					when 2 { return 'Inactive'; }
					when else { return 'Unknown'; }
				}
			}
			]]>
		</example>
	</rule>
</ruleset>

<?xml version="1.0" ?>
<ruleset
	name="Apex Code Style Rules"
	xmlns="http://pmd.sourceforge.net/ruleset/2.0.0"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://pmd.sourceforge.net/ruleset/2.0.0 https://pmd.sourceforge.io/ruleset_2_0_0.xsd"
>
	<description>Custom rules for Apex code style and formatting</description>
	<rule
		name="PreferStringJoinWithSeparatorOverEmpty"
		language="apex"
		message="String.join() with an empty separator where all strings except the last end with the same suffix should use that suffix as the separator"
		class="net.sourceforge.pmd.lang.rule.xpath.XPathRule"
	>
		<description>
			When using String.join() with an empty string separator and all
			strings
			in the list except the last one end with the same non-empty sequence of
			characters, use the common suffix as the separator instead. This makes
			the intent clearer and removes redundant characters from the strings.
			
			Instead of: String.join('', new List &lt; String > {'line1\n', 'line2\n', 'last'});
			Use: String.join('\n', new List &lt; String > {'line1', 'line2', 'last'});
			
			To customize this rule, edit the $minStrings variable at the beginning
			of the XPath expression (default: 3). This sets the minimum number of
			strings required in the list before the rule applies.

			Version: 1.1.0
		</description>
		<priority>3</priority>
		<properties>
			<property name="xpath">
				<value>
					<![CDATA[
					let $minStrings := 3
					return //MethodCallExpression[
						@MethodName = 'join'
						and @FullMethodName = 'String.join'
						and (
							./*[2][self::LiteralExpression[@String = true() and (string-length(@Image) = 0 or @Image = "''" or @Image = '""')]]
							or ./*[3][self::LiteralExpression[@String = true() and (string-length(@Image) = 0 or @Image = "''" or @Image = '""')]]
						)
						and .//NewListLiteralExpression
						and count(.//NewListLiteralExpression//LiteralExpression[@String = true()]) >= $minStrings
					]
					]]>
				</value>
			</property>
		</properties>
		<example>
			<![CDATA[
			// Violation: String.join() with empty separator and common suffix
			String result = String.join('', new List<String>{ 'line1\n', 'line2\n', 'last' });
			
			// Valid: Use the common suffix as separator
			String result = String.join('\n', new List<String>{ 'line1', 'line2', 'last' });
			]]>
		</example>
		<example>
			<![CDATA[
			// Violation: Empty separator with common comma suffix
			String csv = String.join('', new List<String>{ 'col1,', 'col2,', 'col3' });
			
			// Valid: Use comma as separator
			String csv = String.join(',', new List<String>{ 'col1', 'col2', 'col3' });
			]]>
		</example>
		<example>
			<![CDATA[
			// Valid: Non-empty separator is allowed
			String result = String.join('\n', new List<String>{ 'line1', 'line2' });  // ✅
			
			// Valid: No common suffix pattern
			String result = String.join('', new List<String>{ 'a', 'b', 'c' });  // ✅
			]]>
		</example>
	</rule>
</ruleset>

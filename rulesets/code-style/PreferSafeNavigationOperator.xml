<?xml version="1.0" ?>
<ruleset
	name="Apex Code Style Rules"
	xmlns="http://pmd.sourceforge.net/ruleset/2.0.0"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://pmd.sourceforge.net/ruleset/2.0.0 https://pmd.sourceforge.io/ruleset_2_0_0.xsd"
>
	<description>Custom rules for Apex code style and formatting</description>
	<rule
		name="PreferSafeNavigationOperator"
		language="apex"
		message="Use the safe navigation operator (?.) instead of explicit null checks before property access or method calls"
		class="net.sourceforge.pmd.lang.rule.xpath.XPathRule"
	>
		<description>
			Always prefer the safe navigation operator (?.) over null checks
			before
			accessing object properties or calling methods. The safe navigation operator
			is more concise and clearly expresses the intent of safely accessing members
			that may be null.

			This rule only flags simple null checks with a single statement that can be
			safely replaced with the safe navigation operator. It does not flag cases
			where safe navigation cannot be used, such as:
			- Complex conditions with additional logic (e.g., `obj != null and
			obj.isValid()`)
			- Assignments to properties (e.g., `obj.field = value`)
			- Increment/decrement operators (e.g., `++obj.field`, `--obj.field`)
			- Multiple statements in the if block
			- Static method calls (e.g., `String.format()`, `AClass.staticMethod()`)
			- Static field access (e.g., `AClass.staticVariable`, `Integer.MAX_VALUE`)
			- Namespace
			expressions (e.g., `Namespace.Class`, `Trigger.new`, `Flow.interview.flowName`, `Type.class`, `Page.pageName`)
			- SOQL bind expressions (e.g., `[SELECT Name FROM Account WHERE Id = :obj.Id]`)
			- addError() calls on SObject fields (e.g., `obj.field.addError('message')`)

			Version: 1.0.2
		</description>
		<priority>3</priority>
		<properties>
			<property name="xpath">
				<value>
					<![CDATA[
					let $nullOps := ('==', '!='),
						$isNullCheck := function($expr) {
							$expr/VariableExpression[@Image = 'null']
							or $expr/LiteralExpression[@Null = true()]
						},
						$isInstanceMethodCall := function($methodCall, $varName) {
							let $firstRef := $methodCall/ReferenceExpression[1]
							return $firstRef/@Image = $varName
							and not($methodCall/@MethodName = 'addError')
							and not(exists($firstRef/ancestor::PrimaryExpression/ReferenceExpression[1][@Image != $varName]))
						},
						$isInstancePropertyAccess := function($varExpr, $varName) {
							$varExpr/@Image = $varName
							and $varExpr/ReferenceExpression
							and not($varExpr/ancestor::AssignmentExpression)
							and not($varExpr/ancestor::UnaryExpression[@Op = ('++', '--')])
							and not($varExpr/parent::UnaryExpression[@Op = ('++', '--')])
						},
						$isValidUsage := function($block, $varName) {
							exists($block//MethodCallExpression[$isInstanceMethodCall(., $varName)])
							or exists($block//VariableExpression[$isInstancePropertyAccess(., $varName)])
						}
					return //IfBlockStatement[
						let $cond := StandardCondition/BooleanExpression[@Op = $nullOps],
							$varExpr := $cond/VariableExpression[@Image != 'null'],
							$varName := $varExpr/@Image,
							$block := BlockStatement
						return exists($cond)
							and (
								$isNullCheck($cond)
								or exists($cond[VariableExpression[@Image = 'null']])
							)
							and not(exists($cond/BooleanExpression))
							and exists($varName)
							and count($block/*) = 1
							and $isValidUsage($block, $varName)
					]
					]]>
				</value>
			</property>
		</properties>
		<example>
			<![CDATA[
			// Violation: Explicit null check before method call
			if (obj != null) {
				obj.doSomething();
			}
			
			// Violation: Explicit null check before property access
			if (account != null) {
				String name = account.Name;
			}
			
			// Valid: Use safe navigation operator
			obj?.doSomething();
			String name = account?.Name;
			]]>
		</example>
		<example>
			<![CDATA[
			// Violation: Null check with method call
			if (user != null) {
				String email = user.getEmail();
			}
			
			// Violation: Null check with chained property access
			if (account != null) {
				String ownerName = account.Owner.Name;
			}
			
			// Valid: Use safe navigation operator
			String email = user?.getEmail();
			String ownerName = account?.Owner?.Name;
			
			// Valid: Complex null checks with logic (not flagged)
			if (obj != null &amp;&amp; obj.isValid()) {
				obj.process();
			}
			
			// Valid: Assignment to property (not flagged - safe navigation cannot be used)
			if (account != null) {
				account.Name = 'New Name';
			}
			
			// Valid: Multiple statements (not flagged)
			if (obj != null) {
				obj.process();
				obj.finalize();
			}
			
			// Valid: addError on SObject field (not flagged - safe navigation cannot be used)
			if (contact != null) {
				contact.LastName.addError('Required field');
			}
			
			// Valid: Static method call (not flagged - safe navigation cannot be used)
			// String.format() is a static method, ReferenceExpression[1] = 'String' != variable name
			String className = 'MyClass';
			if (className != null) {
				String result = String.format('{0}', 'hello world');
			}
			
			// Valid: Static field access (not flagged - safe navigation cannot be used)
			// Integer.MAX_VALUE is a static field, not an instance field
			String varName = 'MAX_VALUE';
			if (varName != null) {
				Integer max = Integer.MAX_VALUE;
			}
			
			// Valid: Namespace.Class expression (not flagged - safe navigation cannot be used)
			// Multiple ReferenceExpressions indicate namespace/static access
			String ns = 'MyNamespace';
			if (ns != null) {
				// MyNamespace.MyClass.staticMethod() has multiple ReferenceExpressions
			}
			
			// Valid: Increment operator (not flagged - safe navigation cannot be used)
			// ++obj?.field and --obj?.field are not allowed
			Account acc2 = getAccount();
			if (acc2 != null) {
				// ++acc2.SomeField; // Cannot use safe navigation with increment
			}
			
			// Valid: Decrement operator (not flagged - safe navigation cannot be used)
			Account acc3 = getAccount();
			if (acc3 != null) {
				// --acc3.SomeField; // Cannot use safe navigation with decrement
			}
			
			// Valid: Namespace.Class expression (not flagged - safe navigation cannot be used)
			// MyNamespace.MyClass has multiple ReferenceExpressions, not instance access
			String ns = 'MyNamespace';
			if (ns != null) {
				// MyNamespace.MyClass.staticMethod(); // Namespace expression
			}
			
			// Valid: Trigger.new (not flagged - safe navigation cannot be used)
			// Trigger.new is a compile-time constant, not a variable
			Boolean useTrigger = true;
			if (useTrigger != null) {
				// List<Account> accounts = Trigger.new; // Compile-time constant
			}
			
			// Valid: Flow.interview.flowName (not flagged - safe navigation cannot be used)
			// Flow.interview.flowName is a compile-time constant
			String flowName = 'MyFlow';
			if (flowName != null) {
				// Flow.Interview flow = Flow.Interview.MyFlow; // Compile-time constant
			}
			
			// Valid: Page.pageName (not flagged - safe navigation cannot be used)
			// Page.pageName is a compile-time constant
			String pageName = 'MyPage';
			if (pageName != null) {
				// PageReference ref = Page.MyPage; // Compile-time constant
			}
			
			// Valid: SOQL bind expression (not flagged - safe navigation cannot be used)
			// Safe navigation cannot be used in SOQL bind expressions
			Account queryAccount = getAccount();
			if (queryAccount != null) {
				// List<Account> accounts = [SELECT Name FROM Account WHERE Id = :queryAccount.Id];
				// Cannot use: [SELECT Name FROM Account WHERE Id = :queryAccount?.Id];
			}
			]]>
		</example>
	</rule>
</ruleset>

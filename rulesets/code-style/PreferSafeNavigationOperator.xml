<?xml version="1.0" ?>
<ruleset
	name="Apex Code Style Rules"
	xmlns="http://pmd.sourceforge.net/ruleset/2.0.0"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://pmd.sourceforge.net/ruleset/2.0.0 https://pmd.sourceforge.io/ruleset_2_0_0.xsd"
>
	<description>Custom rules for Apex code style and formatting</description>
	<rule
		name="PreferSafeNavigationOperator"
		language="apex"
		message="Use the safe navigation operator (?.) instead of explicit null checks before property access or method calls"
		class="net.sourceforge.pmd.lang.rule.xpath.XPathRule"
	>
		<description>
			Always prefer the safe navigation operator (?.) over null checks
			before
			accessing object properties or calling methods. The safe navigation operator
			is more concise and clearly expresses the intent of safely accessing members
			that may be null.

			Version: 1.0.1
		</description>
		<priority>3</priority>
		<properties>
			<property name="xpath">
				<value>
					<![CDATA[
					let $nullOps := ('==', '!='),
						$isNullCheck := function($expr) {
							$expr/VariableExpression[@Image = 'null']
							or $expr/LiteralExpression[@Null = true()]
						}
					return //IfBlockStatement[
						let $cond := StandardCondition/BooleanExpression[@Op = $nullOps],
							$varExpr := $cond/VariableExpression[@Image != 'null'],
							$varName := $varExpr/@Image
						return exists($cond)
							and (
								$isNullCheck($cond)
								or exists($cond[VariableExpression[@Image = 'null']])
							)
							and exists($varName)
							and count(BlockStatement/*) = 1
							and BlockStatement//MethodCallExpression
							/ReferenceExpression/@Image = $varName
					]
					]]>
				</value>
			</property>
		</properties>
		<example>
			<![CDATA[
			// Violation: Explicit null check before method call
			if (obj != null) {
				obj.doSomething();
			}
			
			// Violation: Explicit null check before property access
			if (account != null) {
				String name = account.Name;
			}
			
			// Valid: Use safe navigation operator
			obj?.doSomething();
			String name = account?.Name;
			]]>
		</example>
		<example>
			<![CDATA[
			// Violation: Null check with method call
			if (user != null) {
				String email = user.getEmail();
			}
			
			// Violation: Null check with chained property access
			if (account != null) {
				String ownerName = account.Owner.Name;
			}
			
			// Valid: Use safe navigation operator
			String email = user?.getEmail();
			String ownerName = account?.Owner?.Name;
			
			// Valid: Complex null checks with logic (not flagged)
			if (obj != null && obj.isValid()) {
				obj.process();
			}
			]]>
		</example>
	</rule>
</ruleset>
